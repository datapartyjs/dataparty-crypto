<html>
    <head>
        <!-- <script src="libs/index.js" type="module"></script> -->

        <script src="node_modules/argon2-browser/lib/argon2.js"></script>
    </head>
    <body>

        <script>

let dataparty_crypto = null

async function main (){
    console.log('wooo!')

    dataparty_crypto = await import('./libs/index.js')

    console.log(dataparty_crypto)


    const phrase = await dataparty_crypto.Routines.generateMnemonic()

    console.log('phrase')
    console.log('\t', phrase)

    let key0 = await dataparty_crypto.Routines.createKey()

    console.log('key0', key0)

    let key = await dataparty_crypto.Routines.createKeyFromMnemonic(phrase)

    console.log('key')
    console.log('\t', key)

    console.log('### Example password')

    const password = 'super-strong-password'
    const salt = await dataparty_crypto.Routines.generateSalt()

    console.log('salt')
    console.log('\t', salt.toString('hex'))

    let startMs = Date.now()

    let key2 = await dataparty_crypto.Routines.createKeyFromPassword(password, salt)

    let endMs = Date.now()

    console.log('key2')
    console.log(key2)

    const deltaMs = endMs - startMs

    console.log('time (ms):', (deltaMs/1000) )



    console.log('### Example messages')    


    const alice = await dataparty_crypto.Identity.fromRandomSeed({id:'alice', key:key0})
    const bob = await dataparty_crypto.Identity.fromRandomSeed({id:'bob', key:key})

    let msg1 = new dataparty_crypto.Message({
        msg: {
            data: 'hello world'
        }
    })

    console.log('alice', alice)
    console.log('bob', bob)

    const msg = await msg1.encrypt(bob, bob.toMini())
        
    const msg2 = new dataparty_crypto.Message(msg)
    
    const output = await msg2.decrypt(bob)

    console.log('\tencrypted message', msg1)
    console.log('\tdecrypted message', msg2)

    console.log(`alice read: ${JSON.stringify(output,null,2)}`)
    console.log('sender', msg2.sender)


    console.log('### Example signatures')

    const aliceCopy = await dataparty_crypto.Identity.fromRandomSeed(alice.toJSON())

    const signedMsg = await alice.sign({a:'hello world'})

    console.log('signedMsg', signedMsg)

    const signedMsgCopy = new dataparty_crypto.Message(signedMsg)

    const verified = await aliceCopy.verify(signedMsgCopy)
    console.log('verified?', verified)
    console.log('message -', signedMsgCopy.msg)
    console.log('sender', signedMsgCopy.sender)

    await signedMsgCopy.assertVerified(aliceCopy)
}

async function argonTest(){

    console.log('Argon Test')

    const fromHexString = (hexString) =>
  Uint8Array.from(hexString.match(/.{1,2}/g).map((byte) => parseInt(byte, 16)));


    const salt = await dataparty_crypto.Routines.generateSalt()



    console.log('\t','salt', salt.toString('hex'))
    console.log(salt)

    console.log(argon2)

    const key = await dataparty_crypto.Routines.createKeyFromPasswordArgon2(
        argon2,
        "supersecretpassword123",
        salt
    )

    console.log(key)

}

async function powTest(){
    console.log('Proof-of-Work test')

    let startMs = Date.now()

    let input = 'these are words - '+startMs

    let work = await dataparty_crypto.Routines.solveProofOfWork(
      input, argon2,
      { timeCost: 3, memoryCost: 1024*8, parallelism: 1, complexity: 9 }
    )

    let endMs = Date.now()

    console.log('the work')
    console.log('\t', work)


    const deltaMs = endMs - startMs

    console.log('solved in (seconds):', (deltaMs/1000) )

    console.log('verifying . . . ')

    let startMs2 = Date.now()

    let verified = await dataparty_crypto.Routines.verifyProofOfWork(
      input,
      work,
      argon2,
      { timeCost: 3, memoryCost: 1024*8, parallelism: 1, complexity: 9 }
    )

    let endMs2 = Date.now()

    let deltaMs2 = endMs2 - startMs2

    console.log('verified in (seconds):', (deltaMs2/1000))
    console.log('verification:', verified)
}


main().catch(err=>{
    console.log('ERROR - we crashed')
    console.log(err)
})
.then(()=>{
    return argonTest()
})
.then(()=>{
    return powTest()
})

        </script>
    </body>
</html>
